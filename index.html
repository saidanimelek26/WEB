<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebADB Pro GUI</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Using the correct WebADB.js library -->
  <script src="https://cdn.jsdelivr.net/gh/webadb/webadb.js@master/dist/webadb.js"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
    .scrollbar-custom::-webkit-scrollbar {
      width: 8px;
    }
    .scrollbar-custom::-webkit-scrollbar-track {
      background: #1f2937;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 4px;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .dark .glass-effect {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-indigo-100 to-purple-100 dark:from-gray-900 dark:via-indigo-900 dark:to-purple-900 transition-colors duration-300">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const adbCommands = [
      { command: "getprop", description: "Device properties" },
      { command: "uname -a", description: "System information" },
      { command: "pm list packages", description: "List installed packages" },
      { command: "ps", description: "Running processes" },
      { command: "dumpsys battery", description: "Battery status" },
      { command: "settings list system", description: "System settings" },
      { command: "logcat -d -t 50", description: "Recent logs" },
    ];

    function App() {
      const [deviceStatus, setDeviceStatus] = useState("Disconnected");
      const [output, setOutput] = useState("");
      const [customCommand, setCustomCommand] = useState("");
      const [adb, setAdb] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");
      const [commandHistory, setCommandHistory] = useState([]);
      const [darkMode, setDarkMode] = useState(true);
      const [deviceInfo, setDeviceInfo] = useState({});

      useEffect(() => {
        document.body.classList.toggle("dark", darkMode);
        localStorage.setItem("theme", darkMode ? "dark" : "light");
      }, [darkMode]);

      useEffect(() => {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          setDarkMode(savedTheme === "dark");
        }
      }, []);

      const connectDevice = async () => {
        setLoading(true);
        setError("");
        try {
          // Using WebADB correctly
          const transport = await Adb.WebUsbTransport.open();
          const adbConnection = await Adb.Client.open(transport, {
            // This is a workaround for WebADB.js connection issues
            dump: false,
            useChecksum: false,
          });
          
          setAdb(adbConnection);
          setDeviceStatus("Connected");
          setOutput("Device connected successfully. Run a command to interact with your device.");
          
          // Try to get basic device info
          try {
            const shell = await adbConnection.shell("getprop ro.product.model && getprop ro.build.version.release");
            const result = await shell.receive();
            const outputText = result.text || "Unknown device";
            setDeviceInfo({
              model: outputText.split('\n')[0] || "Unknown",
              androidVersion: outputText.split('\n')[1] || "Unknown"
            });
          } catch (infoErr) {
            console.log("Could not fetch device info:", infoErr);
          }
        } catch (err) {
          setError(`Connection failed: ${err.message}. Make sure USB debugging is enabled and you've allowed the connection on your device.`);
          setDeviceStatus("Disconnected");
        } finally {
          setLoading(false);
        }
      };

      const disconnectDevice = async () => {
        if (adb) {
          try {
            await adb.close();
          } catch (err) {
            console.error("Error closing connection:", err);
          }
        }
        setAdb(null);
        setDeviceStatus("Disconnected");
        setOutput("Device disconnected.");
        setDeviceInfo({});
      };

      const runCommand = async (command) => {
        if (!adb) {
          setError("No device connected. Please connect a device first.");
          return;
        }
        setLoading(true);
        setError("");
        try {
          const shell = await adb.shell(command);
          const result = await shell.receive();
          const outputText = result.text || "Command executed successfully.";
          setOutput(outputText);
          setCommandHistory((prev) => [
            ...prev.slice(-9),
            { command, output: outputText, timestamp: new Date().toLocaleTimeString() },
          ]);
        } catch (err) {
          setError(`Command failed: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const handleCustomCommand = (e) => {
        e.preventDefault();
        if (customCommand.trim()) {
          runCommand(customCommand);
          setCustomCommand("");
        }
      };

      const clearOutput = () => {
        setOutput("");
        setError("");
      };

      return (
        <div className="min-h-screen flex font-sans">
          {/* Sidebar */}
          <div className="w-64 bg-gray-800 dark:bg-gray-950 text-white p-4 flex flex-col justify-between">
            <div>
              <h1 className="text-2xl font-bold mb-6 flex items-center">
                <span className="bg-blue-600 p-2 rounded-lg mr-2">üîß</span>
                WebADB Pro
              </h1>
              
              <div className="mb-4 glass-effect p-3 rounded-lg">
                <h2 className="text-lg font-semibold mb-2">Device Status</h2>
                <div className="flex items-center mb-2">
                  <div className={`w-3 h-3 rounded-full mr-2 ${deviceStatus === "Connected" ? "bg-green-500" : "bg-red-500"}`}></div>
                  <span>{deviceStatus}</span>
                </div>
                
                {deviceInfo.model && (
                  <div className="mt-3 text-sm">
                    <p className="truncate" title={deviceInfo.model}>
                      <span className="font-medium">Model:</span> {deviceInfo.model}
                    </p>
                    <p>
                      <span className="font-medium">Android:</span> {deviceInfo.androidVersion}
                    </p>
                  </div>
                )}
              </div>
              
              <div className="flex space-x-2 mb-4">
                <button
                  onClick={connectDevice}
                  disabled={loading || deviceStatus === "Connected"}
                  className={`flex-1 py-2 rounded-lg font-medium transition-all duration-200 ${
                    deviceStatus === "Connected"
                      ? "bg-green-600 opacity-50"
                      : "bg-blue-600 hover:bg-blue-700"
                  } disabled:opacity-50`}
                >
                  {loading ? "Connecting..." : "Connect"}
                </button>
                
                <button
                  onClick={disconnectDevice}
                  disabled={!adb}
                  className="flex-1 py-2 bg-red-600 rounded-lg font-medium hover:bg-red-700 disabled:opacity-50 transition-all duration-200"
                >
                  Disconnect
                </button>
              </div>
              
              <div className="mb-6">
                <h2 className="text-lg font-semibold mb-2">Common Commands</h2>
                <div className="space-y-2">
                  {adbCommands.map(({ command, description }) => (
                    <button
                      key={command}
                      onClick={() => runCommand(command)}
                      disabled={loading || !adb}
                      className="w-full text-left p-2 rounded-lg hover:bg-gray-700 transition-all duration-200 disabled:opacity-50 text-sm"
                      title={description}
                    >
                      <span className="font-medium block truncate">{command}</span>
                      <span className="text-xs text-gray-400">{description}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
            
            <div className="space-y-2">
              <button
                onClick={() => setDarkMode(!darkMode)}
                className="w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all duration-200 flex items-center justify-center"
              >
                {darkMode ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode"}
              </button>
              <p className="text-xs text-gray-400 text-center">
                WebADB Pro v1.0
              </p>
            </div>
          </div>

          {/* Main Content */}
          <div className="flex-1 p-6 bg-gray-100 dark:bg-gray-900 overflow-auto">
            <div className="max-w-4xl mx-auto">
              {/* Custom Command */}
              <div className="mb-6 animate-fadeIn">
                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">Custom Command</h2>
                <form onSubmit={handleCustomCommand} className="flex space-x-2">
                  <input
                    type="text"
                    value={customCommand}
                    onChange={(e) => setCustomCommand(e.target.value)}
                    placeholder="Enter ADB command (e.g., pm list packages)"
                    className="flex-1 p-3 border rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                    disabled={!adb}
                  />
                  <button
                    type="submit"
                    disabled={loading || !adb || !customCommand.trim()}
                    className="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-all duration-200"
                  >
                    Run
                  </button>
                  <button
                    type="button"
                    onClick={clearOutput}
                    disabled={!output && !error}
                    className="px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 transition-all duration-200"
                  >
                    Clear
                  </button>
                </form>
                {error && (
                  <div className="mt-3 p-3 bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-lg animate-fadeIn">
                    {error}
                  </div>
                )}
              </div>

              {/* Output */}
              <div className="mb-6 animate-fadeIn">
                <div className="flex justify-between items-center mb-2">
                  <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-200">Output</h2>
                  <span className="text-sm text-gray-500 dark:text-gray-400">
                    {output && `${output.split('\n').length} lines`}
                  </span>
                </div>
                <pre className="bg-gray-800 text-gray-200 p-4 rounded-lg max-h-96 overflow-auto scrollbar-custom whitespace-pre-wrap">
                  {output || "Connect a device and run a command to see output here."}
                </pre>
              </div>

              {/* Command History */}
              <div className="animate-fadeIn">
                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">Command History</h2>
                <div className="bg-white dark:bg-gray-800 rounded-lg p-4 max-h-96 overflow-auto scrollbar-custom">
                  {commandHistory.length === 0 ? (
                    <p className="text-gray-500 dark:text-gray-400">No commands executed yet.</p>
                  ) : (
                    commandHistory.map((entry, index) => (
                      <div key={index} className="mb-3 p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div className="flex justify-between items-start">
                          <p className="text-sm font-medium text-gray-800 dark:text-gray-200">
                            {entry.command}
                          </p>
                          <span className="text-xs text-gray-500 dark:text-gray-400">{entry.timestamp}</span>
                        </div>
                        <p className="text-xs text-gray-600 dark:text-gray-400 mt-1 truncate">
                          {entry.output.split('\n')[0]}
                          {entry.output.includes('\n') && "..."}
                        </p>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
